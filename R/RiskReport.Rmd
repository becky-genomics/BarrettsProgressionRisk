---
title: "Progression Risk Report"
author: "Sarah Killcoyne"
date: "9/27/2018"
output: 
  pdf_document: 
    fig_caption: yes
    fig_height: 4
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
library(pander)
library(gridExtra)
library(Matrix)

#TODO Replace these with the package name
source("private.R")
source('processSWGS.R')

load('inst/model_data.Rdata',verbose=T)
rm(raw.segs,raw.arms,dysplasia.df,labels)
load('inst/all.pt.alpha.Rdata',verbose=T)
rm(plots,dysplasia.df,labels,performance.at.1se)

#load('inst/loo.Rdata',verbose=T)
#rm(plots,dysplasia.df,labels,performance.at.1se)


fitV = models$`0.9`


raw.data = read.table('example/qdnaseq.output.binSize15.raw_read_counts.txt', sep='\t', header=T)
fit.data = read.table('example/qdnaseq.output.binSize15.fitted_read_counts.txt', sep='\t', header=T)

ncol(raw.data)

head(fit.data)


blacklist = read.table('inst/qDNAseq_blacklistedRegions.txt',header=T,sep='\t')

samplenames = colnames(raw.data)[-c(1:4)]
```


Samples provided for analysis from QDNAseq files: `r paste(samplenames, collapse=', ')`. 

`r pander(head(raw.data), caption='Example entries in raw data file', justify='left')`


# Processing pipeline

## Segment genomes

- Exclude `r nrow(blacklist)` regions known to be poorly covered/highly homologous
- Apply the piecewise constant fit algorithm (or multi-pcf) to data after exclusion
- Remove any segments with fewer than 67 supporting bases (ie. equivalent to 1Mb).
- Evaluate residuals filter samples with error rates greater than the cutoff of 0.015.


```{r, warning=F, echo=F}
samplenames = colnames(raw.data)[-c(1:4)]
segmented = segmentRawData(raw.data,fit.data)

message = ""
if (is.null(segmented$failedQC)) {
  message = 'All sampled passed QC.'
} else {
  failedSamples = colnames(segmented$failedQC)[-c(1:5)]
  message = paste( length(failedSamples),'/', length(samplenames), ' failed QC.')
}
```


```{r, warning=F, echo=F, fig.height=length(segmented$seg.plots)}
do.call(grid.arrange, c(segmented$seg.plots, ncol=1, top="Segmented genome"))
```

