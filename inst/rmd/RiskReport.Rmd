---
title: "Progression Risk Report"
author: ""
date: "`r format(Sys.time(), '%d %B %Y')`"
header-includes:
  - \usepackage{comment}
output: 
  pdf_document: 
    fig_caption: yes
    fig_height: 4
    number_sections: yes
    toc: yes
params: 
  path: '.'
  info.file: NULL 
  show.seg.plots: FALSE
---



```{r setup, include=FALSE}
library(BarrettsProgressionRisk)
library(pander)
library(ggrepel)
library(gtable)
library(grid)

knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)


path = params$path
rawFile = grep('raw', list.files(path, pattern='txt', full.names=T), value=T, ignore.case=T)
corrFile = grep('corr|fitted', list.files(path, pattern='txt', full.names=T), value=T,ignore.case=T)

#pr = predictRisk(path)
load('~/tmp/pr.Rdata')
#load('~/workspace/barrettsprogressionrisk/example/pr.Rdata')

samples = c( sampleNames(pr,T), sampleNames(pr,F) )

blacklist = read.table(system.file("extdata", "qDNAseq_blacklistedRegions.txt", package="BarrettsProgressionRisk"), sep = '\t', header=T)

demoFile = params$info.file
withD = ifelse(length(demoFile) == 1, T, F)

samplesdf = data.frame(matrix(samples, ncol=1))
if (length(samples) > 10)
  samplesdf = data.frame(matrix(samples, ncol=3))

```

##### Input Data

Sample files read in:

* Raw file: _`r rawFile`_
* Fitted file: _`r corrFile`_
`r if(!withD) {"\\begin{comment}"}`
* Pathology & p53 IHC reported: _`r demoFile`_
`r if(!withD) {"\\end{comment}"}`

** Samples **
`r length(samples)` samples provided for analysis from QDNAseq files: 

`r pander(samplesdf, col.names=c(rep('',ncol(samplesdf))))` 

`r pander(segmentedValues(pr)[ sample(1:nrow(segmentedValues(pr)), 10) ,c(1:8)], caption='Example of the segmented data.', justify='left', row.names=F)`

For processing and predictions these samples are presumed to be from a single patient. If this is not true please provide separate directories for the raw files from each patient.

\pagebreak

# Processing pipeline

## Segment genomes

- Exclude `r nrow(blacklist)` regions known to be poorly covered/highly homologous
- Apply the piecewise constant fit algorithm (or multi-pcf) to data after exclusion
- Remove any segments with fewer than 67 supporting bases (ie. equivalent to 1Mb).
- Evaluate residuals filter samples with error rates greater than the cutoff of 0.015.

### Passed Quality Control
```{r,echo=F}
passed = subset(sampleResiduals(pr), Pass, select=c('sample','varMAD_median'))
colnames(passed) = c('Sample', 'median(variance(MAD(segments)))')
passed = cbind('Sample#'=1:nrow(passed), passed)
```
The following samples passed post-segmentation QC, variance cutoff < 0.015:
`r pander(passed, justify='left', row.names=F)`

`r if (length(sampleNames(pr,F)) <= 0) {"\\begin{comment}"}`
### Failed Quality Control

The following samples failed post-segmentation QC, variance cutoff > 0.015.
`r pander(subset(sampleResiduals(pr), !Pass, select=c('sample','varMAD_median')), justify='left', row.names=F)` 
`r if (length(sampleNames(pr,F)) <= 0) {"\\end{comment}"}`

`r if (!params$show.seg.plots) {"\\begin{comment}"}`
## Post Segmentation Plots
```{r, warning=F, echo=F, fig.height=length(pr$segmented$seg.plots)*2}
plotSegmentData(pr)
```
`r if (!params$show.seg.plots) {"\\end{comment}"}`

\pagebreak

# Predictions

Risks per-sample were assigned based on percentile calibrations of the probabilities across all samples used to train the model.  Probabilities that fall in the *blue* are *low* risk, *yellow* are *moderate* risk, and *red* are *high* risk.

```{r echo=F, eval=F}
riskCols = riskColors()
fonts = c('plain','italic','bold.italic' )
names(fonts) = names(riskCols)
riskCols = adjustcolor(riskCols,alpha.f=0.8)
names(riskCols) = names(fonts)

tt3 <- gridExtra::ttheme_minimal(
  core=list(bg_params = list(fill=riskCols[predictions(pr)$Risk], col=NA),
            fg_params=list(fontface=fonts[predictions(pr)$Risk]), col='white'),
  colhead=list(fg_params=list(col="black", fontface=4L)),
  padding = unit(c(3, 3), "mm"), text=element_text(size=11,family='Comic Sans MS'))

df = as.data.frame(predictions(pr))
df$`Relative Risk` = round(df$`Relative Risk`,2)
df$Probability = round(df$Probability,2)
table = gridExtra::tableGrob(format(df, core.just='left'),rows=NULL,theme=tt3)
```

For the samples provided the risks are:

```{r, fig.width=5, fig.height=length(samples)*0.5}
#gridExtra::grid.arrange(table)
pander(predictions(pr), emphasize.italics.rows=which(predictions(pr)$Risk == 'Moderate'), emphasize.strong.rows=which(predictions(pr)$Risk == 'High'), justify='left', digits=2, row.names=F)

```

```{r, fig.height=5}
recommendations = rx(pr)

y = c(0.3,0.5,0.8)
names(y) = c('Low','Moderate','High')
preds = predictions(pr)
preds$y = y[preds$Risk]

#pm = plotModelPredictions()
pcal = showPredictionCalibration() + 
  geom_point(data=preds, aes(Probability,y), color='grey39', shape=18, size=5, show.legend = F) + 
  geom_point(data=preds, aes(Probability,y,color=Risk), shape=18, size=4, show.legend=F) 

if (nrow(preds) <= 5) {
  pcal = pcal + geom_text_repel(data=preds, aes(Probability,y,label=Sample,angle=45,segment.color=Risk), show.legend=F )
} else {
  pcal = pcal + geom_text_repel(data=preds, aes(Probability,y,label=rownames(predictions(pr)),angle=45), segment.color='white',show.legend=F )
}
pcal  
```

<!--
### Prediction Plot B

```{r, fig.height=5}
# TODO add predictions(pr) as geom_points on the plot and label them.
pm = plotModelPredictions()
bp = ggplot_build(pm)

preds = predictions(pr)

preds = cbind(preds, do.call(rbind,lapply(preds$Probability, function(p) {
  subset(bp[['data']][[1]], p < xmax & p > xmin, select=c('y','fill'))
})))

for (i in 1:nrow(preds))
  pm = pm + 
  geom_point(data=preds[i,], aes(Probability,y,color=Risk), color='grey39', shape=18, size=5) +
  geom_point(data=preds[i,], aes(Probability,y,color=Risk), color=preds[i,'fill'], shape=18, size=3) + 
  geom_text_repel(data=preds[i,], aes(Probability,y,label=Sample),nudge_y=1)

pm
```
-->

`r if(!withD) {"\\begin{comment}"}`
Per-sample p53 IHC and pathology are included using the provided `r demoFile`.  

`r if(!withD) {"\\end{comment}"}`

```{r echo=F, eval=withD}
demo = read.table(demoFile, sep='\t', header=T)
recommendations = rx(pr,demoFile)
```

\pagebreak

## Rx 

Recommendations per pair of samples, presuming these samples come from different timepoint/endoscopies. Each sample was predicted indpendently and recommendations are evaluated with the following criteria:

1. Immediate RFA: *HGD* or *IMC* diagnosis or more than one consecutive *high* risk predictions.
2. Recheck 6-12 months: One *high* risk prediction or an *aberrant p53 IHC*.
3. Recheck endoscopy 12-24 months: One or more *moderate* risk predictions.
4. Regular surveillance 3-5 years: Two or more consecutive *low* risk predictions.


If no p53 IHC or pathology information is provided the risks alone are used to provide recommendations.

### Recommendations per pair of samples
```{r}
fonts = c('bold.italic','italic','plain','plain' )
riskCols = RColorBrewer::brewer.pal(11, "RdYlBu")[seq(1,11, 3)]
tt3 <- gridExtra::ttheme_minimal(
  core=list(bg_params = list(fill=riskCols[recommendations$rule], col=NA),
            fg_params=list(fontface=fonts[recommendations$rule]), col='white'),
  colhead=list(fg_params=list(col="black", fontface=4L)))

table = gridExtra::tableGrob(format(recommendations[,c('Time 1', 'Time 2', 'Rx')], core.just='left'),rows=NULL,theme=tt3  )

table = gtable_add_grob(table,
        grobs = rectGrob(gp = gpar(fill = NA, lwd = 2)),
        t = 2, b = nrow(table), l = 1, r = ncol(table))

margin = theme(plot.margin = unit(c(0,0), "cm"))
gridExtra::grid.arrange(table,nrow=1,ncol=1)
```


